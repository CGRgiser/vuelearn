<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
    <script>
        // 计算base64编码图片大小
        function getBase64ImageSize(base64) {
            const indexBase64 = base64.indexOf('base64,');
            if (indexBase64 < 0) return -1;
            const str = base64.substr(indexBase64 + 6);
            // 大小单位：字节
            return (str.length * 0.75).toFixed(2);
        }

        /**
         * 	图像压缩，默认同比例压缩
         * @param {Object} imgPath
         *	图像base64编码字符串或图像可访问路径
         * @param {Object} obj
         *	obj 对象 有 width， height， quality(0-1)
         * @param {Object} maxSize
         *	指定压缩后的文件大小，单位：字节
         * @param {Object} callback
         *	回调函数有一个参数，base64的字符串数据
         */
        function compressedImage(imgPath, obj, maxSize, callback) {
            let img = new Image();
            img.src = imgPath;
            img.onload = function () {
                const that = this;
                // 默认按比例压缩
                let w = that.width,
                    h = that.height,
                    scale = w / h;
                w = obj.width || w;
                h = obj.height && obj.height * (w / scale) || h;
                // 生成canvas
                let canvas = document.createElement('canvas');
                let ctx = canvas.getContext('2d');

                canvas.width = w;
                canvas.height = h;

                ctx.drawImage(that, 0, 0, w, h);
                // 图像质量，默认图片质量为0.8
                let quality = 0.8;
                if (obj.quality && obj.quality > 0 && obj.quality <= 1) {
                    quality = obj.quality;
                }
                // quality值越小，所绘制出的图像越模糊
                let newBase64Image = canvas.toDataURL('image/jpeg', quality);

                let fileSize = getBase64ImageSize(newBase64Image);
                if (fileSize > maxSize && quality > 0.01) {
                    if (quality > 0.05) {
                        quality = quality - 0.05;
                    } else {
                        quality = 0.01;
                    }
                    compressedImage(imgPath, {
                        quality: quality
                    }, maxSize, callback);
                    return;
                }

                // 回调函数返回压缩后的 base64图像
                callback(newBase64Image);
            }
        }
        compressedImage('heilongjiangm4-sentinel-13.jpeg', {
            width: 100,
            height: 100,
            quality: 0.8
        }, 1000, function (base64) {
            console.log(base64);
            console.log(getBase64ImageSize(base64))
            console.log(base64ToJpg(base64));
        });
        //base64转jpg



        </script>\
</body>
</html>